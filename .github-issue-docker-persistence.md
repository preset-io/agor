# Docker Database Persistence Issue

## Problem

Database data is lost when restarting the development environment container because the database is being created in `/root/.agor/` instead of `/home/agor/.agor/`.

### Root Cause

The `docker-entrypoint.sh` script runs as **root** by default (even though `USER agor` is set in Dockerfile.dev), causing:

1. `pnpm agor init` creates database in `/root/.agor/agor.db`
2. The Docker volume is mounted at `/home/agor` (not `/root`)
3. Database is not persisted when container restarts

### Evidence

```bash
$ docker exec opencode-agor-dev-1 ls -la /root/.agor/
# Database exists here (not persisted)

$ docker exec opencode-agor-dev-1 ls -la /home/agor/.agor/
# Directory doesn't exist (volume mount location)
```

## Solution

Run all agor CLI commands and daemon/UI processes as the `agor` user instead of root:

### Changes Needed in `docker-entrypoint.sh`

```bash
# 1. Run agor init as agor user
su - agor -c "cd /app && pnpm agor init --skip-if-exists"

# 2. Ensure .agor directory has correct ownership
mkdir -p /home/agor/.agor
chown -R agor:agor /home/agor/.agor
chown agor:agor /home/agor/.agor/config.yaml

# 3. Run user creation as agor user
su - agor -c "cd /app && pnpm --filter @agor/cli exec tsx bin/dev.ts user create-admin --force"

# 4. Run daemon and UI as agor user
su - agor -c "
  cd /app
  PORT=\"${DAEMON_PORT:-3030}\" pnpm --filter @agor/daemon dev &
  DAEMON_PID=\$!
  sleep 3
  VITE_DAEMON_PORT=\"${DAEMON_PORT:-3030}\" pnpm --filter agor-ui dev --host 0.0.0.0 --port \"${UI_PORT:-5173}\"
  kill \$DAEMON_PID 2>/dev/null || true
"
```

## Why This Happens

Docker's `USER` directive (line 43 in Dockerfile.dev) only applies to the default CMD, **not** to ENTRYPOINT scripts. Entrypoint scripts run as root to perform privileged setup tasks, then should drop privileges before running the application.

## Best Practices

This is a common Docker pattern for dev containers that need:
- Root access for setup (mkdir, chown, pnpm install)
- Non-root execution for security and file ownership consistency

Alternative approaches considered:
- **gosu/su-exec**: Cleaner syntax than `su -c`, but requires additional package
- **Separate init container**: Overkill for development environment
- **Build-time setup**: Doesn't work because volume mount overlays the directory

## Testing

After applying fix:

```bash
# 1. Create a session in Agor
# 2. Stop environment
# 3. Start environment
# 4. Verify session still exists (database persisted)

# Verify database location:
docker exec opencode-agor-dev-1 ls -la /home/agor/.agor/agor.db
docker exec opencode-agor-dev-1 ls -la /root/.agor/  # Should not exist
```

## Related Files

- `docker-entrypoint.sh` - Main fix location
- `Dockerfile.dev` - USER directive (doesn't affect entrypoint)
- `docker-compose.yml` - Volume mount at `/home/agor` (correct)

## Priority

**High** - Users lose all session/task data on container restart, making the dev environment frustrating to use.
