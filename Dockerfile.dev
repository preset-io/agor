# Development Dockerfile for Agor
# Supports hot-reload for both daemon and UI
# Extends base image to share system dependencies with production
FROM agor-base

# Copy package files for dependency installation (as root, then chown)
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/agor-daemon/package.json ./apps/agor-daemon/
COPY apps/agor-cli/package.json ./apps/agor-cli/
COPY apps/agor-ui/package.json ./apps/agor-ui/
COPY packages/core/package.json ./packages/core/

# Install dependencies as agor user (cached in Docker layer)
# This creates node_modules with correct platform binaries for container
RUN sudo chown -R agor:agor /app && \
    yes | pnpm install --frozen-lockfile

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN sudo chmod +x /usr/local/bin/docker-entrypoint.sh && \
    sudo chown agor:agor /usr/local/bin/docker-entrypoint.sh

# Expose UI port only (daemon is internal)
EXPOSE ${VITE_PORT:-5173}

# Use entrypoint script to start both processes
ENTRYPOINT ["docker-entrypoint.sh"]
